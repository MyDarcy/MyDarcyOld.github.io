<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Concurrency,Java," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="JDK并发包-JDK并发容器并发容器简介 ConcurrentHashMap：高效的并发HashMap, 线程安全。 ConcurrentLinkedDeque： 高效的并发双端队列，线程安全; ConcurrentLinkedQueue: 高效的并发队列，链表实现，线程安全。可以当作线程安全的LinkedList ConcurrentSkipListMap： 线程安全的Map。采用跳表实现– 快">
<meta name="keywords" content="Concurrency,Java">
<meta property="og:type" content="article">
<meta property="og:title" content="JDK的并发容器">
<meta property="og:url" content="http://yoursite.com/2017/05/21/juc-concurrency-collections/index.html">
<meta property="og:site_name" content="darcy he">
<meta property="og:description" content="JDK并发包-JDK并发容器并发容器简介 ConcurrentHashMap：高效的并发HashMap, 线程安全。 ConcurrentLinkedDeque： 高效的并发双端队列，线程安全; ConcurrentLinkedQueue: 高效的并发队列，链表实现，线程安全。可以当作线程安全的LinkedList ConcurrentSkipListMap： 线程安全的Map。采用跳表实现– 快">
<meta property="og:image" content="http://static.zybuluo.com/csqiang1992/rujgxx0kedfb93wphny6cen1/skiplist.png">
<meta property="og:image" content="http://static.zybuluo.com/csqiang1992/3in1zlihp61tx1g5ltg86hcw/search-7-in-skiplist.png">
<meta property="og:updated_time" content="2017-05-22T07:21:50.617Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JDK的并发容器">
<meta name="twitter:description" content="JDK并发包-JDK并发容器并发容器简介 ConcurrentHashMap：高效的并发HashMap, 线程安全。 ConcurrentLinkedDeque： 高效的并发双端队列，线程安全; ConcurrentLinkedQueue: 高效的并发队列，链表实现，线程安全。可以当作线程安全的LinkedList ConcurrentSkipListMap： 线程安全的Map。采用跳表实现– 快">
<meta name="twitter:image" content="http://static.zybuluo.com/csqiang1992/rujgxx0kedfb93wphny6cen1/skiplist.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/05/21/juc-concurrency-collections/"/>





  <title>JDK的并发容器 | darcy he</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?594cf3672b18c8c9a97689d1dfffaa39";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">darcy he</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">求知 孤勇 温柔</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/21/juc-concurrency-collections/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="darcy.q.cs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/self.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="darcy he">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JDK的并发容器</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-21T22:16:38+08:00">
                2017-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/05/21/juc-concurrency-collections/" class="leancloud_visitors" data-flag-title="JDK的并发容器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="JDK并发包-JDK并发容器"><a href="#JDK并发包-JDK并发容器" class="headerlink" title="JDK并发包-JDK并发容器"></a>JDK并发包-JDK并发容器</h1><h2 id="并发容器简介"><a href="#并发容器简介" class="headerlink" title="并发容器简介"></a>并发容器简介</h2><ul>
<li><code>ConcurrentHashMap</code>：高效的并发HashMap, 线程安全。</li>
<li><code>ConcurrentLinkedDeque</code>： 高效的并发双端队列，线程安全;</li>
<li><code>ConcurrentLinkedQueue</code>: 高效的并发队列，链表实现，线程安全。可以当作线程安全的LinkedList</li>
<li><code>ConcurrentSkipListMap</code>： 线程安全的Map。采用跳表实现– 快速查找。</li>
<li><code>ConcurrentSkipListSet</code>：线程安全的Set。基于ConcurrentSkipListMap实现。同样利用快表的快速查找。</li>
<li><code>CopyOnWriteArrayList</code>：线程安全的List,多读少写的场合下性能很好。</li>
<li><code>CopyOnWriteArraySet</code>：线程安全的Set，同上。</li>
<li><code>BlockingQueue</code>,<code>BlockingDeque</code> ：接口，JDK内部通过链表，数组等方式实现这个接口，表示阻塞队列，适合用作数据共享的通道。<ul>
<li><code>ArrayBlockingQueue</code>, <code>DelayQueue</code>, , <code>LinkedBlockingQueue</code>, <code>LinkedTransferQueue</code>, <code>PriorityBlockingQueue</code>, <code>SynchronousQueue</code>；</li>
<li><code>LinkedBlockingDeque</code></li>
</ul>
</li>
<li><code>Vector</code>, <code>Stack</code>: 线程安全的list, 栈；</li>
<li><code>Collections.synchronizedXXX</code>: 可以将任意的集合包装成为线程安全的。</li>
</ul>
<a id="more"></a>
<h2 id="线程安全的HashMap"><a href="#线程安全的HashMap" class="headerlink" title="线程安全的HashMap"></a>线程安全的HashMap</h2><h3 id="Collections中的方法包装的HashMap"><a href="#Collections中的方法包装的HashMap" class="headerlink" title="Collections中的方法包装的HashMap"></a>Collections中的方法包装的HashMap</h3><ul>
<li>使用Collections.synchronizedMap包装HashMap；基本可以满足线程安全的需求，但是多线程的环境下表现不是太好，因为所有的操作无论是读写都需要首先获得mutex的锁。导致mutex的锁成为瓶颈。</li>
<li>ConcurrentHashMap: JDK8中是通过cas来实现的，JDK1.7中是通过分段锁来实现的。JDK1.8中ConcurrentHashMap的改进</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Map map = Collections.synchronizedMap(<span class="keyword">new</span> HashMap&lt;&gt;());</div><div class="line">Map&lt;Integer, Integer&gt; concurrentHashMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Collections.synchronizedMap会生成一个名为为SynchronizedMap的Map, 委托HashMap实现所有和Map相关的功能，自己则主要负责线程安全。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K,V&gt; m;     <span class="comment">// Backing Map</span></div><div class="line">    <span class="comment">// 通过这个mutex实现对Map m的互斥访问，所有相关的Map操作都会使用这个mutex进行同步，从而实现线程安全。</span></div><div class="line">    <span class="keyword">final</span> Object      mutex;        <span class="comment">// Object on which to synchronize</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.size();&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.isEmpty();&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.containsKey(key);&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.containsValue(value);&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.get(key);&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="JDK1-7中ConcurrentHashMap实现"><a href="#JDK1-7中ConcurrentHashMap实现" class="headerlink" title="JDK1.7中ConcurrentHashMap实现"></a><strong>JDK1.7中ConcurrentHashMap实现</strong></h3><ul>
<li>之前的方案是对整个HashMap加锁，但是这样的加锁粒度太大，JDK1.7中的对于ConconcurrentHashMap，它内部进一步细分了若干个小的HashMap，称为段(Segment)，默认情况下，一个ConcurrentHashMap被细分为16个段。</li>
<li>需要在ConcurrentHashMap中中增加一个表项时，并不是将整个HashMap加锁，而是首先根据hashCode得到该表项应该被存放到哪个段中，然后针对该段加锁，并完成put操作。所以，默认设置下最好可以支持16个线程的同时插入操作。</li>
<li>减少锁粒度也会带来新的问题：当系统需要获取全局锁的时候，消耗的资源比较多。ConconcurrentHashMap的put操作很好的分离了锁，但是当试图获取ConcurrentHashMap的全局信息的时候，就会需要获取所有段的锁才能继续实施。譬如ConcurrentHashMap的size方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;  </span></div><div class="line">        <span class="keyword">implements</span> <span class="title">ConcurrentMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;, <span class="title">Serializable</span> &#123;  </div><div class="line">  </div><div class="line">    <span class="comment">// 将整个hashmap分成几个小的map，每个segment都是一个锁；与hashtable相比，这么设计的目的是对于put, remove等操作，可以减少并发冲突，对  </span></div><div class="line">    <span class="comment">// 不属于同一个片段的节点可以并发操作，大大提高了性能  </span></div><div class="line">    <span class="keyword">final</span> Segment&lt;K,V&gt;[] segments;  </div><div class="line">  </div><div class="line">    <span class="comment">// 本质上Segment类就是一个小的hashmap，里面table数组存储了各个节点的数据，继承了ReentrantLock, 可以作为互拆锁使用  </span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Segment</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;  </div><div class="line">        <span class="keyword">transient</span> <span class="keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;  </div><div class="line">        <span class="keyword">transient</span> <span class="keyword">int</span> count;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">// 基本节点，存储Key， Value值  </span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;  </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;  </div><div class="line">        <span class="keyword">final</span> K key;  </div><div class="line">        <span class="keyword">volatile</span> V value;  </div><div class="line">        <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Maps the specified key to the specified value in this table.</div><div class="line">     * Neither the key nor the value can be null.</div><div class="line">     *</div><div class="line">     * &lt;p&gt; The value can be retrieved by calling the &lt;tt&gt;get&lt;/tt&gt; method</div><div class="line">     * with a key that is equal to the original key.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> key key with which the specified value is to be associated</div><div class="line">     * <span class="doctag">@param</span> value value to be associated with the specified key</div><div class="line">     * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</div><div class="line">     *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;</div><div class="line">     * <span class="doctag">@throws</span> NullPointerException if the specified key or value is null</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        Segment&lt;K,V&gt; s;</div><div class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</div><div class="line">        <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject          <span class="comment">// nonvolatile; recheck</span></div><div class="line">             (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="keyword">null</span>) <span class="comment">//  in ensureSegment</span></div><div class="line">            s = ensureSegment(j);</div><div class="line">        <span class="keyword">return</span> s.put(key, hash, value, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the number of key-value mappings in this map.  If the</div><div class="line">     * map contains more than &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt; elements, returns</div><div class="line">     * &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the number of key-value mappings in this map</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Try a few times to get accurate count. On failure due to</span></div><div class="line">        <span class="comment">// continuous async changes in table, resort to locking.</span></div><div class="line">        <span class="keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="keyword">this</span>.segments;</div><div class="line">        <span class="keyword">int</span> size;</div><div class="line">        <span class="keyword">boolean</span> overflow; <span class="comment">// true if size overflows 32 bits</span></div><div class="line">        <span class="keyword">long</span> sum;         <span class="comment">// sum of modCounts</span></div><div class="line">        <span class="keyword">long</span> last = <span class="number">0L</span>;   <span class="comment">// previous sum</span></div><div class="line">        <span class="keyword">int</span> retries = -<span class="number">1</span>; <span class="comment">// first iteration isn't retry</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) &#123;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; segments.length; ++j)</div><div class="line">                        ensureSegment(j).lock(); <span class="comment">// force creation</span></div><div class="line">                &#125;</div><div class="line">                sum = <span class="number">0L</span>;</div><div class="line">                size = <span class="number">0</span>;</div><div class="line">                overflow = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; segments.length; ++j) &#123;</div><div class="line">                    Segment&lt;K,V&gt; seg = segmentAt(segments, j);</div><div class="line">                    <span class="keyword">if</span> (seg != <span class="keyword">null</span>) &#123;</div><div class="line">                        sum += seg.modCount;</div><div class="line">                        <span class="keyword">int</span> c = seg.count;</div><div class="line">                        <span class="keyword">if</span> (c &lt; <span class="number">0</span> || (size += c) &lt; <span class="number">0</span>)</div><div class="line">                            overflow = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (sum == last)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                last = sum;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; segments.length; ++j)</div><div class="line">                    segmentAt(segments, j).unlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> overflow ? Integer.MAX_VALUE : size;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="JDK1-8中ConcurrentHashMap的实现"><a href="#JDK1-8中ConcurrentHashMap的实现" class="headerlink" title="JDK1.8中ConcurrentHashMap的实现"></a><strong>JDK1.8中ConcurrentHashMap的实现</strong></h3><ul>
<li>JDK1.8相比JDK1.7的改进<ul>
<li>改进一：取消segments字段，直接采用transient volatile HashEntry<k,v> table保存数据，采用table数组元素作为锁，从而实现了对每一行数据进行加锁，进一步减少并发冲突的概率。</k,v></li>
<li>改进二：将原先table数组＋单向链表的数据结构，变更为table数组＋单向链表＋红黑树的结构。对于hash表来说，最核心的能力在于将key hash之后能均匀的分布在数组中。如果hash之后散列的很均匀，那么table数组中的每个队列长度主要为0或者1。但实际情况并非总是如此理想，虽然ConcurrentHashMap类默认的加载因子为0.75，但是在数据量过大或者运气不佳的情况下，还是会存在一些队列长度过长的情况，如果还是采用单向列表方式，那么查询某个节点的时间复杂度为O(n)；因此，对于个数超过8(默认值)的列表，jdk1.8中采用了红黑树的结构，那么查询的时间复杂度可以降低到O(logN)，可以改进性能。 </li>
</ul>
</li>
<li>新增字段 transient volatile CounterCell[] counterCells; 可方便的计算hashmap中所有元素的个数，性能大大优于jdk1.7中的size()方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// putVal方法的实现；</span></div><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();  </div><div class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());  </div><div class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;  </div><div class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;  </div><div class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;  </div><div class="line">        <span class="comment">// 如果table为空，初始化；否则，根据hash值计算得到数组索引i，如果tab[i]为空，直接新建节点Node即可。注：tab[i]实质为链表或者红黑树的首节点。  </span></div><div class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)  </div><div class="line">            tab = initTable();  </div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,  </div><div class="line">                         <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))  </div><div class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin  </span></div><div class="line">        &#125;  </div><div class="line">        <span class="comment">// 如果tab[i]不为空并且hash值为MOVED，说明该链表正在进行transfer操作，返回扩容完成后的table。  </span></div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)  </div><div class="line">            tab = helpTransfer(tab, f);  </div><div class="line">        <span class="keyword">else</span> &#123;  </div><div class="line">            V oldVal = <span class="keyword">null</span>;  </div><div class="line">            <span class="comment">// 针对首个节点进行加锁操作，而不是segment，进一步减少线程冲突  </span></div><div class="line">            <span class="keyword">synchronized</span> (f) &#123;  </div><div class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;  </div><div class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;  </div><div class="line">                        binCount = <span class="number">1</span>;  </div><div class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;  </div><div class="line">                            K ek;  </div><div class="line">                            <span class="comment">// 如果在链表中找到值为key的节点e，直接设置e.val = value即可。  </span></div><div class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;  </div><div class="line">                                ((ek = e.key) == key ||  </div><div class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;  </div><div class="line">                                oldVal = e.val;  </div><div class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)  </div><div class="line">                                    e.val = value;  </div><div class="line">                                <span class="keyword">break</span>;  </div><div class="line">                            &#125;  </div><div class="line">                            <span class="comment">// 如果没有找到值为key的节点，直接新建Node并加入链表即可。  </span></div><div class="line">                            Node&lt;K,V&gt; pred = e;  </div><div class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;  </div><div class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,  </div><div class="line">                                                          value, <span class="keyword">null</span>);  </div><div class="line">                                <span class="keyword">break</span>;  </div><div class="line">                            &#125;  </div><div class="line">                        &#125;  </div><div class="line">                    &#125;  </div><div class="line">                    <span class="comment">// 如果首节点为TreeBin类型，说明为红黑树结构，执行putTreeVal操作。  </span></div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;  </div><div class="line">                        Node&lt;K,V&gt; p;  </div><div class="line">                        binCount = <span class="number">2</span>;  </div><div class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,  </div><div class="line">                                                       value)) != <span class="keyword">null</span>) &#123;  </div><div class="line">                            oldVal = p.val;  </div><div class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)  </div><div class="line">                                p.val = value;  </div><div class="line">                        &#125;  </div><div class="line">                    &#125;  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;  </div><div class="line">                <span class="comment">// 如果节点数&gt;＝8，那么转换链表结构为红黑树结构。  </span></div><div class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)  </div><div class="line">                    treeifyBin(tab, i);  </div><div class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)  </div><div class="line">                    <span class="keyword">return</span> oldVal;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    <span class="comment">// 计数增加1，有可能触发transfer操作(扩容)。  </span></div><div class="line">    addCount(<span class="number">1L</span>, binCount);  </div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">public class ConconrrentHashMapDemo &#123;</div><div class="line">    public final static int THREAD_POOL_SIZE = 5;</div><div class="line">    public static Map&lt;String, Integer&gt; hashTable = null;</div><div class="line">    public static Map&lt;String, Integer&gt; synchronizedHashMap = null;</div><div class="line">    public static Map&lt;String, Integer&gt; concurrentHashMap = null;</div><div class="line">    public static void main(String[] args) throws InterruptedException &#123;</div><div class="line"></div><div class="line">        hashTable = new Hashtable&lt;&gt;();</div><div class="line">        test(hashTable);</div><div class="line"></div><div class="line">        synchronizedHashMap = Collections.synchronizedMap(new HashMap&lt;String, Integer&gt;());</div><div class="line">        test(synchronizedHashMap);</div><div class="line"></div><div class="line">        concurrentHashMap = new ConcurrentHashMap&lt;&gt;();</div><div class="line">        test(concurrentHashMap);</div><div class="line">    &#125;</div><div class="line">    public static void test(final Map&lt;String, Integer&gt; map) throws InterruptedException &#123;</div><div class="line">        System.out.println("Test started for: " + map.getClass());</div><div class="line">        long averageTime = 0;</div><div class="line">        for (int i = 0; i &lt; 5; i++) &#123;</div><div class="line">            long startTime = System.nanoTime();</div><div class="line">            ExecutorService executorService = Executors.newFixedThreadPool(THREAD_POOL_SIZE);</div><div class="line">            for (int j = 0; j &lt; THREAD_POOL_SIZE; j++) &#123;</div><div class="line">                executorService.execute(new Runnable() &#123;</div><div class="line">                    @SuppressWarnings("unused")</div><div class="line">                    @Override</div><div class="line">                    public void run() &#123;</div><div class="line">                        for (int i = 0; i &lt; 500000; i++) &#123;</div><div class="line">                            Integer i1 = (int) Math.ceil(Math.random() * 550000);</div><div class="line">                            // Retrieve value. We are not using it anywhere</div><div class="line">                            Integer i2 = map.get(String.valueOf(i1));</div><div class="line">                            // Put value</div><div class="line">                            map.put(String.valueOf(i1), i1);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            // Make sure executor stops</div><div class="line">            executorService.shutdown();</div><div class="line">            // Blocks until all tasks have completed execution after a shutdown request</div><div class="line">            executorService.awaitTermination(Long.MAX_VALUE, TimeUnit.DAYS);</div><div class="line">            long entTime = System.nanoTime();</div><div class="line">            long totalTime = (entTime - startTime) / 1000000L;</div><div class="line">            averageTime += totalTime;</div><div class="line">            System.out.println("2500K entried added/retrieved in " + totalTime + " ms");</div><div class="line">        &#125;</div><div class="line">        System.out.println("For " + map.getClass() + " the average time is " + averageTime / 5 + " ms\n");</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&gt; output</div><div class="line">Test started for: class java.util.Hashtable</div><div class="line">2500K entried added/retrieved in 3442 ms</div><div class="line">2500K entried added/retrieved in 3834 ms</div><div class="line">2500K entried added/retrieved in 3812 ms</div><div class="line">2500K entried added/retrieved in 3588 ms</div><div class="line">2500K entried added/retrieved in 3496 ms</div><div class="line">For class java.util.Hashtable the average time is 3634 ms</div><div class="line"></div><div class="line">Test started for: class java.util.Collections$SynchronizedMap</div><div class="line">2500K entried added/retrieved in 3677 ms</div><div class="line">2500K entried added/retrieved in 4277 ms</div><div class="line">2500K entried added/retrieved in 3754 ms</div><div class="line">2500K entried added/retrieved in 3556 ms</div><div class="line">2500K entried added/retrieved in 3484 ms</div><div class="line">For class java.util.Collections$SynchronizedMap the average time is 3749 ms</div><div class="line"></div><div class="line">Test started for: class java.util.concurrent.ConcurrentHashMap</div><div class="line">2500K entried added/retrieved in 797 ms</div><div class="line">2500K entried added/retrieved in 512 ms</div><div class="line">2500K entried added/retrieved in 502 ms</div><div class="line">2500K entried added/retrieved in 1210 ms</div><div class="line">2500K entried added/retrieved in 508 ms</div><div class="line">For class java.util.concurrent.ConcurrentHashMap the average time is 705 ms</div></pre></td></tr></table></figure>
<h2 id="List的线程安全"><a href="#List的线程安全" class="headerlink" title="List的线程安全"></a>List的线程安全</h2><ul>
<li>ArrayList和LinkedList都不是线程安全的，但是Vector是线程安全的(不推荐使用)；往往是通过Collections中的方法来构造线程安全的ArrayList和LinkedList类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; list = Collections.synchronizedList(<span class="keyword">new</span> ArrayList&lt;Integer&gt;());</div></pre></td></tr></table></figure>
<h2 id="ConcurrentLinkedQueue的实现"><a href="#ConcurrentLinkedQueue的实现" class="headerlink" title="ConcurrentLinkedQueue的实现"></a>ConcurrentLinkedQueue的实现</h2><ul>
<li>高并发环境下性能最好的队列。</li>
<li>略复杂，后面再专门写一篇。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * An unbounded thread-safe &#123;<span class="doctag">@linkplain</span> Queue queue&#125; based on linked nodes.</div><div class="line"> * This queue orders elements FIFO (first-in-first-out).</div><div class="line"> * The &lt;em&gt;head&lt;/em&gt; of the queue is that element that has been on the</div><div class="line"> * queue the longest time.</div><div class="line"> * The &lt;em&gt;tail&lt;/em&gt; of the queue is that element that has been on the</div><div class="line"> * queue the shortest time. New elements</div><div class="line"> * are inserted at the tail of the queue, and the queue retrieval</div><div class="line"> * operations obtain elements at the head of the queue.</div><div class="line"> * A &#123;<span class="doctag">@code</span> ConcurrentLinkedQueue&#125; is an appropriate choice when</div><div class="line"> * many threads will share access to a common collection.</div><div class="line"> * Like most other concurrent collection implementations, this class</div><div class="line"> * does not permit the use of &#123;<span class="doctag">@code</span> null&#125; elements.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentLinkedQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">volatile</span> E item;</div><div class="line">        <span class="keyword">volatile</span> Node&lt;E&gt; next;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Constructs a new node.  Uses relaxed write because item can</div><div class="line">         * only be seen after publication via casNext.</div><div class="line">         */</div><div class="line">        Node(E item) &#123;</div><div class="line">            UNSAFE.putObject(<span class="keyword">this</span>, itemOffset, item);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 对Node节点进行操作时候，使用CAS操作。第一个参数为期望值，第二个参数为设置目标值。当当前值等于期望值的时候，就将目标设置为val; </span></div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">casItem</span><span class="params">(E cmp, E val)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, itemOffset, cmp, val);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">lazySetNext</span><span class="params">(Node&lt;E&gt; val)</span> </span>&#123;</div><div class="line">            UNSAFE.putOrderedObject(<span class="keyword">this</span>, nextOffset, val);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">casNext</span><span class="params">(Node&lt;E&gt; cmp, Node&lt;E&gt; val)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, nextOffset, cmp, val);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; head;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; tail;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a &#123;<span class="doctag">@code</span> ConcurrentLinkedQueue&#125; that is initially empty.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentLinkedQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        head = tail = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Inserts the specified element at the tail of this queue.</div><div class="line">     * As the queue is unbounded, this method will never throw</div><div class="line">     * &#123;<span class="doctag">@link</span> IllegalStateException&#125; or return &#123;<span class="doctag">@code</span> false&#125;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> offer(e);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ....</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Inserts the specified element at the tail of this queue.</div><div class="line">     * As the queue is unbounded, this method will never return &#123;<span class="doctag">@code</span> false&#125;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">        checkNotNull(e);</div><div class="line">        <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;E&gt;(e);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</div><div class="line">            Node&lt;E&gt; q = p.next;</div><div class="line">            <span class="keyword">if</span> (q == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// p is last node</span></div><div class="line">                <span class="comment">// 第一次加入元素时候，</span></div><div class="line">                <span class="keyword">if</span> (p.casNext(<span class="keyword">null</span>, newNode)) &#123;</div><div class="line">                    <span class="comment">// Successful CAS is the linearization point</span></div><div class="line">                    <span class="comment">// for e to become an element of this queue,</span></div><div class="line">                    <span class="comment">// and for newNode to become "live".</span></div><div class="line">                    <span class="comment">// 每2次更新一下tail;</span></div><div class="line">                    <span class="keyword">if</span> (p != t) <span class="comment">// hop two nodes at a time</span></div><div class="line">                        casTail(t, newNode);  <span class="comment">// Failure is OK.</span></div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Lost CAS race to another thread; re-read next</span></div><div class="line">                <span class="comment">// CAS竞争失败;</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</div><div class="line">                <span class="comment">// We have fallen off list.  If tail is unchanged, it</span></div><div class="line">                <span class="comment">// will also be off-list, in which case we need to</span></div><div class="line">                <span class="comment">// jump to head, from which all live nodes are always</span></div><div class="line">                <span class="comment">// reachable.  Else the new tail is a better bet.</span></div><div class="line">                p = (t != (t = tail)) ? t : head;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="comment">// Check for tail updates after two hops.</span></div><div class="line">                p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">        restartFromHead:</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</div><div class="line">                E item = p.item;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (item != <span class="keyword">null</span> &amp;&amp; p.casItem(item, <span class="keyword">null</span>)) &#123;</div><div class="line">                    <span class="comment">// Successful CAS is the linearization point</span></div><div class="line">                    <span class="comment">// for item to be removed from this queue.</span></div><div class="line">                    <span class="keyword">if</span> (p != h) <span class="comment">// hop two nodes at a time</span></div><div class="line">                        updateHead(h, ((q = p.next) != <span class="keyword">null</span>) ? q : p);</div><div class="line">                    <span class="keyword">return</span> item;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((q = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                    updateHead(h, p);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</div><div class="line">                    <span class="keyword">continue</span> restartFromHead;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    p = q;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="不变模式下的CopyOnWriteArrayList"><a href="#不变模式下的CopyOnWriteArrayList" class="headerlink" title="不变模式下的CopyOnWriteArrayList"></a>不变模式下的CopyOnWriteArrayList</h2><ul>
<li>CopyOnWriteArrayList的读取操作不用加锁，写入操作也不用加锁，只有写入和写入之间需要进行同步等待。CopyOnWrite– 写入操作的时候进行一次自我复制。当这个List需要修改的时候并不修改原来的内容（保证当前在读线程的数据一致性），而是对原来的数据进行一次复制，将修改的内容写入到副本中，写完之后再将修改完后的副本替换原来的数据。</li>
<li>读操作不涉及任何同步控制和锁的操作，理由就是内部的array不会发生修改而是被另外一个array替换。</li>
<li>写入操作需要锁– 仅仅用于控制写-写的情况，内部需要进行完整的数据复制，然后在新的副本上进行修改，最后将新的副本替换老副本。修改完成。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 读操作的实现</span></div><div class="line"><span class="comment">/** The array, accessed only via getArray/setArray. */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> get(getArray(), index);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Gets the array.  Non-private so as to also be accessible</div><div class="line"> * from CopyOnWriteArraySet class.</div><div class="line"> */</div><div class="line"><span class="keyword">final</span> Object[] getArray() &#123;</div><div class="line">    <span class="keyword">return</span> array;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> E <span class="title">get</span><span class="params">(Object[] a, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (E) a[index];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 写操作的实现</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">    lock.lock();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Object[] elements = getArray();</div><div class="line">        <span class="keyword">int</span> len = elements.length;</div><div class="line">        <span class="comment">// 进行了内部元素的完整复制。</span></div><div class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</div><div class="line">        <span class="comment">// 将新的元素加入到newElements中</span></div><div class="line">        newElements[len] = e;</div><div class="line">        <span class="comment">// 新的数据替换老的数组，修改就完成了。读线程立即可以察觉到这个改变，因为array是volatile类型的。</span></div><div class="line">        setArray(newElements);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="BlockingQueue-数据共享通道"><a href="#BlockingQueue-数据共享通道" class="headerlink" title="BlockingQueue: 数据共享通道"></a>BlockingQueue: 数据共享通道</h2><ul>
<li>当我们希望线程A能够通知线程B又希望线程A不知道线程B的存在。这样就是一个松散耦合的。线程B可以轻松进行替换或者升级。</li>
<li>BlockingQueue是一个接口，具体的实现有多个，文章开头有提到。这里看一下ArrayBlockingQueue(数组实现，可以用作有界队列)和LinkedBlockingQueue（链表实现，可以用作无界队列）。当队列为空的时候，消费者线程会被阻塞，有的元素的时候，消费者线程会被唤醒。</li>
<li>入队列: offer() 和 put()方法，对于offer()方法，队列满立即返回false，没有满，正常的入队列操作。put()方法如果队列满了会一致等待直到队列中右空闲位置。</li>
<li>出队列: poll() 和 take()方法，对于poll()方法，队列空立即返回null，不为空，正常的出操作。take()方法如果队列空了会一致等待直到队列中有新的元素。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line"><span class="comment">/** The queued items */</span></div><div class="line"><span class="keyword">final</span> Object[] items;</div><div class="line"></div><div class="line"><span class="comment">/** items index for next take, poll, peek or remove */</span></div><div class="line"><span class="keyword">int</span> takeIndex;</div><div class="line"></div><div class="line"><span class="comment">/** items index for next put, offer, or add */</span></div><div class="line"><span class="keyword">int</span> putIndex;</div><div class="line"></div><div class="line"><span class="comment">/** Number of elements in the queue */</span></div><div class="line"><span class="keyword">int</span> count;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Concurrency control uses the classic two-condition algorithm</div><div class="line"> * found in any textbook.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/** Main lock guarding all access */</span></div><div class="line"><span class="keyword">final</span> ReentrantLock lock;</div><div class="line"></div><div class="line"><span class="comment">/** Condition for waiting takes */</span></div><div class="line"><span class="comment">// take操作的时候，队列为空，那么让当前线程等待在notEmpty上，新元素入队列时，进行一次notEmpty上的通知。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</div><div class="line"></div><div class="line"><span class="comment">/** Condition for waiting puts */</span></div><div class="line"><span class="comment">// put操作的时候，队列满了，那么让当前线程等待在notFull上，有线程取元素的时候，进行一词notFull通知。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">    lock.lockInterruptibly();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">while</span> (count == <span class="number">0</span>)</div><div class="line">            notEmpty.await(); <span class="comment">// here; </span></div><div class="line">        <span class="keyword">return</span> dequeue();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Inserts element at current put position, advances, and signals.</div><div class="line"> * Call only when holding lock.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</div><div class="line">    <span class="comment">// assert lock.getHoldCount() == 1;</span></div><div class="line">    <span class="comment">// assert items[putIndex] == null;</span></div><div class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</div><div class="line">    items[putIndex] = x;</div><div class="line">    <span class="keyword">if</span> (++putIndex == items.length)</div><div class="line">        putIndex = <span class="number">0</span>;</div><div class="line">    count++;</div><div class="line">    notEmpty.signal(); <span class="comment">//here</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Inserts the specified element at the tail of this queue, waiting</div><div class="line"> * for space to become available if the queue is full.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    checkNotNull(e);</div><div class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">    lock.lockInterruptibly();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">while</span> (count == items.length)</div><div class="line">            notFull.await(); <span class="comment">// here</span></div><div class="line">        enqueue(e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Extracts element at current take position, advances, and signals.</div><div class="line"> * Call only when holding lock.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// assert lock.getHoldCount() == 1;</span></div><div class="line">    <span class="comment">// assert items[takeIndex] != null;</span></div><div class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    E x = (E) items[takeIndex];</div><div class="line">    items[takeIndex] = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (++takeIndex == items.length)</div><div class="line">        takeIndex = <span class="number">0</span>;</div><div class="line">    count--;</div><div class="line">    <span class="keyword">if</span> (itrs != <span class="keyword">null</span>)</div><div class="line">        itrs.elementDequeued();</div><div class="line">    notFull.signal(); <span class="comment">// here</span></div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="SkipList-跳表-随机数据结构"><a href="#SkipList-跳表-随机数据结构" class="headerlink" title="SkipList: 跳表(随机数据结构)"></a>SkipList: 跳表(随机数据结构)</h2><ul>
<li>跳表： 快速查找，有点类似于平衡树，但是于平衡树的区别是：对平衡树的插入和删除可能导致树进行一次全局的调整，但是跳表的插入和删除只需要对整个数据结构的局部进行操作即可。所以，高并发的情况下，需要一个全局锁来保证平衡树的安全性但是对于跳表只需要一个细粒度的锁。跳表的查询性能也是O(logN)；</li>
<li>最底层的链表维护了跳表内的所有元素，上面每层链表都是下层链表的子集。</li>
<li>跳表内所有链表都是排序的，查找的时候可以从顶级链表开始找，一旦发现被查找的元素大于当前链表的取值，就会转入下一层链表继续找。所以搜索的过程中是跳跃性的。</li>
<li>使用跳表实现的Map和Hash实现的Map的不同还在于：Hashb并不维护元素的顺序，而跳表内的所有元素都是排序的，所以对跳表的遍历会得到一个<strong>有序的结果</strong>。</li>
<li>对于跳表的所有操作，就是组织好这些Index的关系。</li>
</ul>
<p><img src="http://static.zybuluo.com/csqiang1992/rujgxx0kedfb93wphny6cen1/skiplist.png" alt="skiplist.png-62.5kB"></p>
<p><img src="http://static.zybuluo.com/csqiang1992/3in1zlihp61tx1g5ltg86hcw/search-7-in-skiplist.png" alt="search-7-in-skiplist.png-69.7kB"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A scalable concurrent &#123;<span class="doctag">@link</span> ConcurrentNavigableMap&#125; implementation.</div><div class="line"> * The map is sorted according to the &#123;<span class="doctag">@linkplain</span> Comparable natural</div><div class="line"> * ordering&#125; of its keys, or by a &#123;<span class="doctag">@link</span> Comparator&#125; provided at map</div><div class="line"> * creation time, depending on which constructor is used.</div><div class="line"> * <span class="doctag">@since</span> 1.6</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">ConcurrentNavigableMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> K key;</div><div class="line">        <span class="keyword">volatile</span> Object value;</div><div class="line">        <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</div><div class="line">        </div><div class="line">        <span class="comment">// CAS实现</span></div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">casValue</span><span class="params">(Object cmp, Object val)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, valueOffset, cmp, val);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// CAS实现</span></div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">casNext</span><span class="params">(Node&lt;K,V&gt; cmp, Node&lt;K,V&gt; val)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, nextOffset, cmp, val);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//....</span></div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Index nodes represent the levels of the skip list.  Note that</div><div class="line">     * even though both Nodes and Indexes have forward-pointing</div><div class="line">     * fields, they have different types and are handled in different</div><div class="line">     * ways, that can't nicely be captured by placing field in a</div><div class="line">     * shared abstract class.</div><div class="line">     */</div><div class="line">     <span class="comment">// 含有节点和向下的引用和向右的引用</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Index</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> Node&lt;K,V&gt; node;</div><div class="line">        <span class="keyword">final</span> Index&lt;K,V&gt; down;</div><div class="line">        <span class="keyword">volatile</span> Index&lt;K,V&gt; right;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Nodes heading each level keep track of their level.</div><div class="line">     */</div><div class="line">     <span class="comment">// 对于每一层的表头，还需要记录当前在哪一层。</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HeadIndex</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Index</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> level;</div><div class="line">        HeadIndex(Node&lt;K,V&gt; node, Index&lt;K,V&gt; down, Index&lt;K,V&gt; right, <span class="keyword">int</span> level) &#123;</div><div class="line">            <span class="keyword">super</span>(node, down, right);</div><div class="line">            <span class="keyword">this</span>.level = level;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>demo</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencySkipListMapDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ConcurrentSkipListMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> ConcurrentSkipListMap();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</div><div class="line">            map.put(i, i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; entry : map.entrySet()) &#123;</div><div class="line">            System.out.println(entry.getKey() + <span class="string">"\t"</span> + entry.getValue());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println();</div><div class="line">        <span class="keyword">for</span> (Integer key : map.keySet()) &#123;</div><div class="line">            System.out.println(key + <span class="string">"\t"</span> + map.get(key));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&gt; output</div><div class="line"><span class="number">0</span>	<span class="number">0</span></div><div class="line"><span class="number">1</span>	<span class="number">1</span></div><div class="line"><span class="number">2</span>	<span class="number">2</span></div><div class="line"><span class="number">3</span>	<span class="number">3</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><ol>
<li><a href="http://blog.csdn.net/fjse51/article/details/55260493" target="_blank" rel="external">jdk1.8中ConcurrentHashMap的实现原理</a></li>
<li><a href="http://blog.csdn.net/wangxiaotongfan/article/details/52074160" target="_blank" rel="external">java8中对ConcurrentHashMap的改进</a></li>
<li><a href="http://blog.csdn.net/do_smile/article/details/46911727" target="_blank" rel="external">Java 8 中的ConcurrentHashMap源码分析</a></li>
<li><a href="https://yq.aliyun.com/articles/36781" target="_blank" rel="external">ConcurrentHashMap源码分析–Java8</a></li>
<li><a href="http://blog.csdn.net/u010887744/article/details/50637030" target="_blank" rel="external">ConcurrentHashMap源码分析–Java8</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Concurrency/" rel="tag"># Concurrency</a>
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/21/juc-executors-more-practical/" rel="next" title="JDK并发包-线程池-深入">
                <i class="fa fa-chevron-left"></i> JDK并发包-线程池-深入
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/22/java-synchronized-key-word/" rel="prev" title="Synchronized及其实现原理">
                Synchronized及其实现原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/self.jpg"
               alt="darcy.q.cs" />
          <p class="site-author-name" itemprop="name">darcy.q.cs</p>
           
              <p class="site-description motion-element" itemprop="description">心怀孤勇.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MyDarcy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/70670266" target="_blank" title="douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  douban
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/frobisher27149" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.zhenlanghuo.top/" title="zhenlang huo" target="_blank">zhenlang huo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://xawei.me/" title="xinan wei" target="_blank">xinan wei</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JDK并发包-JDK并发容器"><span class="nav-number">1.</span> <span class="nav-text">JDK并发包-JDK并发容器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#并发容器简介"><span class="nav-number">1.1.</span> <span class="nav-text">并发容器简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程安全的HashMap"><span class="nav-number">1.2.</span> <span class="nav-text">线程安全的HashMap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Collections中的方法包装的HashMap"><span class="nav-number">1.2.1.</span> <span class="nav-text">Collections中的方法包装的HashMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK1-7中ConcurrentHashMap实现"><span class="nav-number">1.2.2.</span> <span class="nav-text">JDK1.7中ConcurrentHashMap实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK1-8中ConcurrentHashMap的实现"><span class="nav-number">1.2.3.</span> <span class="nav-text">JDK1.8中ConcurrentHashMap的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#性能对比"><span class="nav-number">1.2.4.</span> <span class="nav-text">性能对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#List的线程安全"><span class="nav-number">1.3.</span> <span class="nav-text">List的线程安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConcurrentLinkedQueue的实现"><span class="nav-number">1.4.</span> <span class="nav-text">ConcurrentLinkedQueue的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不变模式下的CopyOnWriteArrayList"><span class="nav-number">1.5.</span> <span class="nav-text">不变模式下的CopyOnWriteArrayList</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BlockingQueue-数据共享通道"><span class="nav-number">1.6.</span> <span class="nav-text">BlockingQueue: 数据共享通道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SkipList-跳表-随机数据结构"><span class="nav-number">1.7.</span> <span class="nav-text">SkipList: 跳表(随机数据结构)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ref"><span class="nav-number">2.</span> <span class="nav-text">Ref</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">darcy.q.cs</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("nDVrc1Rvjlwx4V9XScsLSm9q-gzGzoHsz", "4ONqgToWREwRHxcX9qRXFhlL");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
