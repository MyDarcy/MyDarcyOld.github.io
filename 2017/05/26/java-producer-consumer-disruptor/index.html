<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Java,Producer,Consumer," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="BlockingQueue 实现生产者和消费者模式简单易懂，但是BlockingQueue并不是一个高性能的实现。它完全使用锁和阻塞来实现线程之间的同步。在高并发的场合，它的性能并不是特别的优越。ConconcurrentLinkedQueue是一个高性能的队列，但是BlockingQueue只是为了方便数据的共享。ConcurrentLinkedQueue高效的秘诀就在于其大量的CAS实现。D">
<meta name="keywords" content="Java,Producer,Consumer">
<meta property="og:type" content="article">
<meta property="og:title" content="高性能的生产者-消费者：无锁的实现">
<meta property="og:url" content="http://yoursite.com/2017/05/26/java-producer-consumer-disruptor/index.html">
<meta property="og:site_name" content="darcy he">
<meta property="og:description" content="BlockingQueue 实现生产者和消费者模式简单易懂，但是BlockingQueue并不是一个高性能的实现。它完全使用锁和阻塞来实现线程之间的同步。在高并发的场合，它的性能并不是特别的优越。ConconcurrentLinkedQueue是一个高性能的队列，但是BlockingQueue只是为了方便数据的共享。ConcurrentLinkedQueue高效的秘诀就在于其大量的CAS实现。D">
<meta property="og:image" content="http://static.zybuluo.com/csqiang1992/gsaczd8hnyxvyfvrkulvttjd/cpu-cache.png">
<meta property="og:updated_time" content="2017-05-26T12:38:17.813Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="高性能的生产者-消费者：无锁的实现">
<meta name="twitter:description" content="BlockingQueue 实现生产者和消费者模式简单易懂，但是BlockingQueue并不是一个高性能的实现。它完全使用锁和阻塞来实现线程之间的同步。在高并发的场合，它的性能并不是特别的优越。ConconcurrentLinkedQueue是一个高性能的队列，但是BlockingQueue只是为了方便数据的共享。ConcurrentLinkedQueue高效的秘诀就在于其大量的CAS实现。D">
<meta name="twitter:image" content="http://static.zybuluo.com/csqiang1992/gsaczd8hnyxvyfvrkulvttjd/cpu-cache.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/05/26/java-producer-consumer-disruptor/"/>





  <title>高性能的生产者-消费者：无锁的实现 | darcy he</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?594cf3672b18c8c9a97689d1dfffaa39";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">darcy he</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">求知 孤勇 温柔</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/26/java-producer-consumer-disruptor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="darcy.q.cs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/self.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="darcy he">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">高性能的生产者-消费者：无锁的实现</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-26T20:34:06+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/05/26/java-producer-consumer-disruptor/" class="leancloud_visitors" data-flag-title="高性能的生产者-消费者：无锁的实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>BlockingQueue 实现生产者和消费者模式简单易懂，但是BlockingQueue并不是一个高性能的实现。它完全使用锁和阻塞来实现线程之间的同步。在高并发的场合，它的性能并不是特别的优越。ConconcurrentLinkedQueue是一个高性能的队列，但是BlockingQueue只是为了方便数据的共享。<br>ConcurrentLinkedQueue高效的秘诀就在于其大量的CAS实现。Disuptor框架则解决了CAS高效但是难于实现的问题。</p>
</blockquote>
<a id="more"></a>
<h2 id="无锁的缓存框架-Disruptor"><a href="#无锁的缓存框架-Disruptor" class="headerlink" title="无锁的缓存框架: Disruptor"></a>无锁的缓存框架: Disruptor</h2><ul>
<li>Disruptor是LMAX公司开发的高效的无锁缓存队列。它使用无锁的方式实现了一个环形队列。非常适合于实现生产者和消费者模式，如：事件和消息的发布。</li>
<li>Disruptor别出心裁的使用了一个<strong>环形队列(RingBuffer)</strong>来代替普通线性队列。此环形队列内部实现为一个普通的数组，对于一般的队列，一般要提供head和tail指针用于出队和入队，增加了线程协作时候的复杂度。但是对于环形队列，则只需要对外提供一个当前位置cursor,利用此cursor既执行可以入队也可以出队操作。</li>
<li>由于是环形队列的缘故，队列的总大小需要事先指定(底层数组)，不能够动态的拓展。为了能够从一个序列快速的对应到数组的实际位置，Disruptor要求我们必须将数组的大小设置为2的整数次方，这样就能够<strong>通过<code>sequence&amp;(queueSize - 1)</code> 立即定位实际的元素位置index</strong>,比取余操作(<code>%</code>)快很多。（注意: queueSize为2的n次方（<code>n+1位</code>），那么<code>queueSize - 1</code>就是最高为为0, 其他为全为1的数字，那么就可以将sequence限定在<code>queueSize-1</code>范围内，并且不会右任何一位的浪费）</li>
<li>向环形队列中放入和取出数据都是采用<strong>CAS操作</strong>来做的。</li>
<li>固定大小的环形队列另一个好处就是系统的运行过程中，不会有新的空间需要分配或者老的空间需要回收。所以可以大大降低这方面的额外开销。</li>
<li>根据Disruptor的官方报告，Disruptor的性能要比BlockingQueue至少高一个数量级以上。</li>
</ul>
<h2 id="Disruptor实现生产者消费者"><a href="#Disruptor实现生产者消费者" class="headerlink" title="Disruptor实现生产者消费者"></a>Disruptor实现生产者消费者</h2><ul>
<li>生产者不断的产生整数，消费者读取生产者的数据，计算平方。</li>
</ul>
<h3 id="PCData-java"><a href="#PCData-java" class="headerlink" title="PCData.java"></a>PCData.java</h3><ul>
<li>要处理的数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PCData</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> value;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Consumer-java"><a href="#Consumer-java" class="headerlink" title="Consumer.java"></a>Consumer.java</h3><ul>
<li>消费者需要实现WorkHandler接口, 消费者的作用就是读取数据就是处理，具体的数据读取就是由Disruptor框架进行了封装。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 消费者需要实现WorkHandler接口, 消费者的作用就是读取数据就是处理，具体的数据读取就是由Disruptor框架进行了封装。</div><div class="line">public class Consumer implements WorkHandler&lt;PCData&gt; &#123;</div><div class="line">    // onEvent作为框架的回调方法, 在这里对数据进行处理。</div><div class="line">    @Override</div><div class="line">    public void onEvent(PCData pcData) throws Exception &#123;</div><div class="line">        System.out.println(Thread.currentThread().getId() + &quot;:Event: --&quot; + pcData.get() * pcData.get() + &quot;--&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PCDataFacotory-java"><a href="#PCDataFacotory-java" class="headerlink" title="PCDataFacotory.java"></a>PCDataFacotory.java</h3><ul>
<li>产生PCDataFacotry的工厂类, 会在Disruptor系统初始化的时候，构造所有的缓冲区中的对象实例（Disruptor会预先分配空间）。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PCDataFactory</span> <span class="keyword">implements</span> <span class="title">EventFactory</span>&lt;<span class="title">PCData</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> PCData <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PCData();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Producer-java"><a href="#Producer-java" class="headerlink" title="Producer.java"></a>Producer.java</h3><ul>
<li>生产者需要一个环形缓冲区，自定义的putData方法接收ByteBuffer对象，取出其中的数据并且装载到环形缓冲区中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</div><div class="line">    <span class="comment">// 环形缓冲区</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RingBuffer&lt;PCData&gt; ringBuffer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(RingBuffer&lt;PCData&gt; ringBuffer)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ringBuffer = ringBuffer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将产生的数据放入到缓冲区中：将传入的ByteBuffer中的数据提取出来, 并装载到环形缓冲区中。</div><div class="line">     * <span class="doctag">@param</span> data ByteBuffer可以包装任何类型的数据, 这里包装long类型的数据。</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pushData</span><span class="params">(ByteBuffer data)</span> </span>&#123;</div><div class="line">        <span class="comment">// 得到下一个可用的序列号.</span></div><div class="line">        <span class="keyword">long</span> sequence = ringBuffer.next();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 通过序列号，取得下一个空闲的PCData对象,</span></div><div class="line">            PCData pcData = ringBuffer.get(sequence);</div><div class="line">            <span class="comment">// 将PCData对象设置为期望值，这个值会最终传递到消费者。</span></div><div class="line">            pcData.set(data.getLong(<span class="number">0</span>));</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// 数据的发布，只有发布后的数据才会真正的被消费者看见.</span></div><div class="line">            ringBuffer.publish(sequence);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Main.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        ExecutorService es = Executors.newCachedThreadPool();</div><div class="line">        PCDataFactory factory = <span class="keyword">new</span> PCDataFactory();</div><div class="line">        <span class="comment">// 设置环形缓冲区的大小为1024(2^10),</span></div><div class="line">        <span class="keyword">int</span> bufferSize = <span class="number">1024</span>;</div><div class="line">        <span class="comment">// 创建disruptor对象, 封装了整个disruptor的调用;</span></div><div class="line">        Disruptor&lt;PCData&gt; disruptor = <span class="keyword">new</span> Disruptor&lt;PCData&gt;(factory,</div><div class="line">                bufferSize,</div><div class="line">                es,</div><div class="line">                ProducerType.MULTI,</div><div class="line">                <span class="keyword">new</span> BlockingWaitStrategy());</div><div class="line"></div><div class="line">        <span class="comment">// 设置了数据的消费者，这里设置4个消费者实例，系统会为每一个消费者实例映射到</span></div><div class="line">        <span class="comment">// 一个线程, 所以这里提供了4个消费者线程.</span></div><div class="line">        disruptor.handleEventsWithWorkerPool(</div><div class="line">                <span class="keyword">new</span> Consumer(),</div><div class="line">                <span class="keyword">new</span> Consumer(),</div><div class="line">                <span class="keyword">new</span> Consumer(),</div><div class="line">                <span class="keyword">new</span> Consumer()</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="comment">// 启动并且初始化disruptor对象,</span></div><div class="line">        disruptor.start();</div><div class="line">        RingBuffer&lt;PCData&gt; ringBuffer = disruptor.getRingBuffer();</div><div class="line">        Producer producer = <span class="keyword">new</span> Producer(ringBuffer);</div><div class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">8</span>);</div><div class="line">        <span class="comment">// 由生产者向缓冲区中存放数据.</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> l = <span class="number">0</span>; <span class="keyword">true</span>; ++l) &#123;</div><div class="line">            byteBuffer.putLong(<span class="number">0</span>, l);</div><div class="line">            producer.pushData(byteBuffer);</div><div class="line">            Thread.sleep(<span class="number">100</span>);</div><div class="line">            System.out.println(<span class="string">"add data "</span> + l);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&gt; output</div><div class="line">add data <span class="number">0</span></div><div class="line"><span class="number">12</span>:Event: --<span class="number">0</span>--</div><div class="line">add data <span class="number">1</span></div><div class="line"><span class="number">15</span>:Event: --<span class="number">1</span>--</div><div class="line">add data <span class="number">2</span></div><div class="line"><span class="number">14</span>:Event: --<span class="number">4</span>--</div><div class="line">add data <span class="number">3</span></div><div class="line"><span class="number">13</span>:Event: --<span class="number">9</span>--</div><div class="line">add data <span class="number">4</span></div><div class="line"><span class="number">12</span>:Event: --<span class="number">16</span>--</div><div class="line">add data <span class="number">5</span></div><div class="line"><span class="number">15</span>:Event: --<span class="number">25</span>--</div><div class="line"><span class="comment">// ... more ...</span></div></pre></td></tr></table></figure>
<h2 id="提高消费者的响应时间-选择何时的策略"><a href="#提高消费者的响应时间-选择何时的策略" class="headerlink" title="提高消费者的响应时间: 选择何时的策略"></a>提高消费者的响应时间: 选择何时的策略</h2><ul>
<li>当有的数据在环形缓冲区产生的时候，消费者如何知道这些新产生的数据呢？消费者如何监控缓冲区中的信息？Disruptor提供了几种对WaitStrategy策略的实现：<ul>
<li>BlockingWaitingStrategy: 默认的策略，和使用BlockingQueue非常相似，都是使用<strong>锁和条件(Condition)进行数据的监控和线程的唤醒</strong>。因为涉及到线程的切换，BlockingWaitingStrategy最节省CPU，但是在高并发的环境下表现糟糕。</li>
<li>SleepingWaitStrategy: 对CPU的使用非常保守。 会在循环中不断的等待数据。<strong>首先进行自旋等待，如果不成功，则使用Thread.yield()让出CPU，并且使用LockSupport.parkNanos(1)进行线程的休眠，以确保不会占用太多的CPU数据</strong>。所以此策略对于数据的处理可能产生比较高的延时。它比较适合于对延时要求不是特别高的场合，好处是对生产者线程的影响最小。应用场景是异步日志。</li>
<li>YieldingWaitStrategy: 用于低延时场景，消费者会不断的循环监控缓冲区的变化，而在<strong>循环内部，会使用Thread.yield()让出CPU时间，适用于高性能而且对延时有较高要求的系统</strong>。使用这种策略时，相当于消费者线程变成了一个内部执行Thread.yield()的死循环。最好右多于消费者线程数目的逻辑CPU数目。</li>
<li>BusySpinWaitStrategy: 疯狂的策略，就是一<strong>个死循环。消费者线程会尽最大努力疯狂监控缓冲区的变化</strong>。所以，它会吃掉所有的CPU资源。只有在对延迟非常苛刻的场合可以考虑使用它。物理CPU的数目必须大于消费者线程的数目。</li>
</ul>
</li>
</ul>
<h2 id="CPU-Cache的优化-解决伪共享的问题"><a href="#CPU-Cache的优化-解决伪共享的问题" class="headerlink" title="CPU Cache的优化: 解决伪共享的问题"></a>CPU Cache的优化: 解决伪共享的问题</h2><h3 id="什么是伪共享问题"><a href="#什么是伪共享问题" class="headerlink" title="什么是伪共享问题"></a><strong>什么是伪共享问题</strong></h3><ul>
<li>为了提高CPU的速度，CPU有一个高速缓存Cache。<strong>在高速缓存中，读写数据的最小单位为缓存行(Cache Line), 它是从主存(Memory)复制到缓存(Cache)的最小单位</strong>。如果两个变量存放在一个缓存行中，那么在多线程访问中，可能会影响彼此的性能。</li>
<li>如下图1, X和Y都在同一个缓存行，运行在CPU1上的线程更新了X，那么CPU2上的缓存行就会失效，即使Y并没有修改，导致Cache无法命中。接着，CPU2上的线程更新了Y，那么CPU1上的缓存行就会失效。这样往复，缓存经常不能命中，系统的吞吐量急剧下降。</li>
<li>可行的做法之一就是：在X变量的前后空间都占据一定的位置, 填充padding，那么当内存被读入到缓存的时候，这个缓存行中，只有X一个变量是实际有效的。所以就不会发生多个线程同时修改缓存行中的不同的变量而导致变量全部失效的情况。</li>
</ul>
<p><img src="http://static.zybuluo.com/csqiang1992/gsaczd8hnyxvyfvrkulvttjd/cpu-cache.png" alt="cpu-cache.png-186.8kB"></p>
<h3 id="伪共享的解决"><a href="#伪共享的解决" class="headerlink" title="伪共享的解决"></a>伪共享的解决</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//  查看物理CPU个数</div><div class="line">darcy@darcy-ubuntu:~$ cat /proc/cpuinfo| grep &quot;physical id&quot;| sort| uniq| wc -l</div><div class="line">2</div><div class="line"></div><div class="line">// 查看每个物理CPU中core的个数(即核数)</div><div class="line">darcy@darcy-ubuntu:~$ cat /proc/cpuinfo| grep &quot;cpu cores&quot;| uniq</div><div class="line">cpu cores	: 4</div><div class="line"></div><div class="line">// 查看逻辑CPU的个数</div><div class="line">darcy@darcy-ubuntu:~$ cat /proc/cpuinfo| grep &quot;processor&quot;| wc -l</div><div class="line">8</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FalseSharing</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NUMBER_THREADS = <span class="number">4</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ITERATIONS = <span class="number">500L</span> * <span class="number">1000L</span> * <span class="number">1000L</span>;</div><div class="line">    <span class="comment">// 每个线程都会访问自己对应的longs中的元素.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> arrayIndex;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> VolatileLong[] longs = <span class="keyword">new</span> VolatileLong[NUMBER_THREADS];</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; longs.length; i++) &#123;</div><div class="line">            longs[i] = <span class="keyword">new</span> VolatileLong();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FalseSharing</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> arrayIndex)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.arrayIndex = arrayIndex;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">        runTest();</div><div class="line">        System.out.println(<span class="string">"duration = "</span> + (System.currentTimeMillis() - start));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Thread[] threads = <span class="keyword">new</span> Thread[NUMBER_THREADS];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.length; i++) &#123;</div><div class="line">            threads[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> FalseSharing(i));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</div><div class="line">            thread.start();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</div><div class="line">            thread.join();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> iterations = ITERATIONS + <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (<span class="number">1</span> != --iterations) &#123;</div><div class="line">            longs[arrayIndex].value = iterations;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileLong</span> </span>&#123;</div><div class="line">        <span class="comment">// 只有value是被使用的, 其他的都是填充.防止数组中几个对象value进入了同一行。</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value = <span class="number">0L</span>;</div><div class="line">        <span class="comment">// 填充行， </span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6, p7;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&gt; output</div><div class="line"><span class="comment">// 不注释填充行</span></div><div class="line">duration = <span class="number">5477</span></div><div class="line"></div><div class="line"><span class="comment">// 注释</span></div><div class="line">duration = <span class="number">66414</span></div></pre></td></tr></table></figure>
<h3 id="Disruptor解决伪共享问题"><a href="#Disruptor解决伪共享问题" class="headerlink" title="Disruptor解决伪共享问题"></a>Disruptor解决伪共享问题</h3><p><strong>Disrupator内部的填充</strong></p>
<ul>
<li>Sequence组件会被频繁的访问，虽然在Sequence中主要使用的只有value，但是通过LhsPadding和RhsPadding,在这个value的前后安置了一些占位空间，使得value可以无冲突的存在于缓存中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LhsPadding</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p1;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p2;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p3;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p4;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p5;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p6;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p7;</div><div class="line"></div><div class="line">    LhsPadding() &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Value</span> <span class="keyword">extends</span> <span class="title">LhsPadding</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value;</div><div class="line"></div><div class="line">    Value() &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RhsPadding</span> <span class="keyword">extends</span> <span class="title">Value</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p9;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p10;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p11;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p12;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p13;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p14;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p15;</div><div class="line"></div><div class="line">    RhsPadding() &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sequence</span> <span class="keyword">extends</span> <span class="title">RhsPadding</span> </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Producer/" rel="tag"># Producer</a>
          
            <a href="/tags/Consumer/" rel="tag"># Consumer</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/26/java-simple-producer-consumer/" rel="next" title="简单生产者消费者模式">
                <i class="fa fa-chevron-left"></i> 简单生产者消费者模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/26/java-future-pattern/" rel="prev" title="Future模式浅析">
                Future模式浅析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/self.jpg"
               alt="darcy.q.cs" />
          <p class="site-author-name" itemprop="name">darcy.q.cs</p>
           
              <p class="site-description motion-element" itemprop="description">心怀孤勇.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MyDarcy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/70670266" target="_blank" title="douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  douban
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/frobisher27149" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.zhenlanghuo.top/" title="zhenlang huo" target="_blank">zhenlang huo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://xawei.me/" title="xinan wei" target="_blank">xinan wei</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#无锁的缓存框架-Disruptor"><span class="nav-number">1.</span> <span class="nav-text">无锁的缓存框架: Disruptor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disruptor实现生产者消费者"><span class="nav-number">2.</span> <span class="nav-text">Disruptor实现生产者消费者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PCData-java"><span class="nav-number">2.1.</span> <span class="nav-text">PCData.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consumer-java"><span class="nav-number">2.2.</span> <span class="nav-text">Consumer.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PCDataFacotory-java"><span class="nav-number">2.3.</span> <span class="nav-text">PCDataFacotory.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Producer-java"><span class="nav-number">2.4.</span> <span class="nav-text">Producer.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#提高消费者的响应时间-选择何时的策略"><span class="nav-number">3.</span> <span class="nav-text">提高消费者的响应时间: 选择何时的策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU-Cache的优化-解决伪共享的问题"><span class="nav-number">4.</span> <span class="nav-text">CPU Cache的优化: 解决伪共享的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是伪共享问题"><span class="nav-number">4.1.</span> <span class="nav-text">什么是伪共享问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#伪共享的解决"><span class="nav-number">4.2.</span> <span class="nav-text">伪共享的解决</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Disruptor解决伪共享问题"><span class="nav-number">4.3.</span> <span class="nav-text">Disruptor解决伪共享问题</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">darcy.q.cs</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("nDVrc1Rvjlwx4V9XScsLSm9q-gzGzoHsz", "4ONqgToWREwRHxcX9qRXFhlL");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
